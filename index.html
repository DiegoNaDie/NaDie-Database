<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tabela de Precificação para Confeitaria</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            padding: 0.5rem;
            background-color: #f8f9fa;
            color: #212529;
        }
        .container {
            max-width: 600px;
            margin: auto;
            background: #fff;
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .tabs {
            display: flex;
            border-bottom: 1px solid #dee2e6;
            margin-bottom: 1rem;
        }
        .tab-button {
            padding: 10px 15px;
            cursor: pointer;
            border: none;
            background-color: #e9ecef;
            color: #495057;
            font-size: 1rem;
            border-top-left-radius: 5px;
            border-top-right-radius: 5px;
            margin-right: 2px;
        }
        .tab-button.active {
            border-bottom: 2px solid #007bff;
            font-weight: bold;
            background-color: #fff;
            color: #007bff;
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        input, select, button {
            width: 100%;
            padding: 12px;
            margin-bottom: 12px;
            border-radius: 5px;
            border: 1px solid #ced4da;
            box-sizing: border-box;
            font-size: 1rem;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
        }
        button:hover { background-color: #0056b3; }
        
        .btn-secondary { background-color: #6c757d; }
        .btn-secondary:hover { background-color: #5a6268; }
        .btn-success { background-color: #28a745; }
        .btn-success:hover { background-color: #218838; }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        th, td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
            vertical-align: middle;
        }
        .actions-cell { text-align: right; }
        .actions-cell button {
            width: auto;
            padding: 5px 10px;
            font-size: 0.8rem;
            margin-left: 5px;
        }
        .btn-edit { background-color: #ffc107; color: black;}
        .btn-edit:hover { background-color: #e0a800; }
        .btn-delete { background-color: #dc3545; }
        .btn-delete:hover { background-color: #c82333; }
        
        .recipe-ingredient-row {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-bottom: 8px;
        }
        .recipe-ingredient-row .ing-select { flex: 3; }
        .recipe-ingredient-row .ing-qty { flex: 2; }
        .recipe-ingredient-row .ing-unit { flex: 2; }
        
        .result-box, .saved-recipe-card {
            margin-top: 1rem;
            padding: 1rem;
            background-color: #f1f3f5;
            border-radius: 5px;
            border: 1px solid #dee2e6;
        }
        .saved-recipe-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .saved-recipe-card-header-title {
            cursor: pointer;
            flex-grow: 1;
        }
        .saved-recipe-card h4 {
            margin: 0;
            color: #007bff;
        }
        .recipe-details {
            display: none;
            margin-top: 1rem;
            border-top: 1px solid #ced4da;
            padding-top: 1rem;
        }
        .recipe-details ul {
            padding-left: 20px;
            list-style: square;
        }
        .menu-container {
            position: relative;
        }
        .menu-button {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.5rem;
            line-height: 1;
            padding: 5px;
            color: #6c757d;
        }
        .menu-dropdown {
            display: none;
            position: absolute;
            right: 0;
            top: 30px;
            background-color: white;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            z-index: 100;
        }
        .menu-dropdown a {
            display: block;
            padding: 10px 15px;
            text-decoration: none;
            color: black;
            font-size: 0.9rem;
            white-space: nowrap;
        }
        .menu-dropdown a:hover {
            background-color: #f1f1f1;
        }
        .backup-controls {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #dee2e6;
        }
        #import-input {
            display: none;
        }
    </style>
</head>
<body>

<div class="container">
    <div class="tabs">
        <button id="tab-btn-ingredientes" class="tab-button active" onclick="openTab(event, 'ingredientes')">Ingredientes</button>
        <button id="tab-btn-receitas" class="tab-button" onclick="openTab(event, 'receitas')">Nova Receita</button>
        <button id="tab-btn-receitas-salvas" class="tab-button" onclick="openTab(event, 'receitas-salvas')">Receitas Salvas</button>
    </div>

    <div id="ingredientes" class="tab-content active">
        <h3>Cadastro de Ingredientes</h3>
        <input type="hidden" id="ingredient-id">
        <input type="text" id="ingredient-name" placeholder="Nome do Ingrediente">
        <input type="number" id="ingredient-price" placeholder="Preço do Pacote/Unidade (R$)">
        <input type="number" id="ingredient-quantity" placeholder="Quantidade na Embalagem">
        <select id="ingredient-unit">
            <option value="g">Gramas (g)</option>
            <option value="kg">Quilogramas (kg)</option>
            <option value="ml">Mililitros (ml)</option>
            <option value="l">Litros (l)</option>
            <option value="un">Unidade(s)</option>
        </select>
        <button id="ingredient-submit-btn" onclick="addOrUpdateIngredient()">Adicionar Ingrediente</button>
        <table id="ingredients-table">
            <thead>
                <tr>
                    <th>Ingrediente</th>
                    <th>Custo</th>
                    <th class="actions-cell">Ações</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <div id="receitas" class="tab-content">
        <h3 id="recipe-form-title">Nova Receita</h3>
        <input type="hidden" id="recipe-id">
        <input type="text" id="recipe-name" placeholder="Nome da Receita">
        <div id="recipe-ingredients"></div>
        <button onclick="addRecipeIngredientField()">+ Adicionar Ingrediente</button>
        <hr>
        <h4>Definição de Preço</h4>
        <input type="number" id="profit-margin" placeholder="Lucro Desejado (%)">
        <input type="number" id="additional-tax" placeholder="Custos Adicionais (gás, luz, etc %)">
        <input type="number" id="per-order-fee-percentage" placeholder="Taxa por Pedido (app, cartão %)">
        <button class="btn-secondary" onclick="calculateAndDisplayCurrentRecipe()">Calcular Preço</button>
        <button id="recipe-submit-btn" onclick="saveOrUpdateRecipe()">Salvar Receita</button>
        <div class="result-box" id="recipe-cost-result"></div>
    </div>

    <div id="receitas-salvas" class="tab-content">
        <h3>Suas Receitas Salvas</h3>
        <div id="saved-recipes-container"><p>Nenhuma receita salva ainda.</p></div>
        
        <div class="backup-controls">
            <h4>Backup e Restauração</h4>
            <button class="btn-secondary" onclick="exportBackup()">Exportar Backup</button>
            <button class="btn-success" onclick="document.getElementById('import-input').click()">Importar Backup</button>
            <input type="file" id="import-input" accept=".json" onchange="importBackup(event)">
        </div>
    </div>
</div>

<script>
    let ingredients = [];
    let savedRecipes = [];

    // Funções de Navegação e UI
    function openTab(evt, tabName) {
        document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
        document.querySelectorAll('.tab-button').forEach(tb => tb.classList.remove('active'));
        document.getElementById(tabName).classList.add('active');
        evt.currentTarget.classList.add('active');
    }

    function toggleRecipeDetails(cardElement) {
        const details = cardElement.querySelector('.recipe-details');
        details.style.display = details.style.display === 'block' ? 'none' : 'block';
    }
    
    function toggleActionMenu(button) {
        const dropdown = button.nextElementSibling;
        dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
    }
    
    window.onclick = function(event) {
        if (!event.target.matches('.menu-button')) {
            document.querySelectorAll('.menu-dropdown').forEach(dropdown => {
                dropdown.style.display = 'none';
            });
        }
    }


    // Funções de Gerenciamento de Ingredientes
    function addOrUpdateIngredient() {
        const id = document.getElementById('ingredient-id').value;
        const name = document.getElementById('ingredient-name').value.trim();
        const price = parseFloat(document.getElementById('ingredient-price').value);
        const quantity = parseFloat(document.getElementById('ingredient-quantity').value);
        const unit = document.getElementById('ingredient-unit').value;

        if (!name || isNaN(price) || isNaN(quantity)) {
            alert('Por favor, preencha todos os campos do ingrediente.');
            return;
        }

        const costPerBaseUnit = price / quantity;

        if (id) { // Atualizando
            const index = ingredients.findIndex(ing => ing.id == id);
            if (index > -1) {
                ingredients[index] = { ...ingredients[index], name, price, quantity, unit, costPerBaseUnit };
            }
        } else { // Adicionando
            const newId = Date.now();
            ingredients.push({ id: newId, name, price, quantity, unit, costPerBaseUnit });
        }
        
        saveIngredients();
        rebuildIngredientsTable();
        updateAllSavedRecipes();
        clearIngredientForm();
    }
    
    function editIngredient(id) {
        const ingredient = ingredients.find(ing => ing.id == id);
        if (!ingredient) return;
        document.getElementById('ingredient-id').value = ingredient.id;
        document.getElementById('ingredient-name').value = ingredient.name;
        document.getElementById('ingredient-price').value = ingredient.price;
        document.getElementById('ingredient-quantity').value = ingredient.quantity;
        document.getElementById('ingredient-unit').value = ingredient.unit;
        document.getElementById('ingredient-submit-btn').textContent = "Atualizar Ingrediente";
        document.getElementById('tab-btn-ingredientes').click();
    }

    function deleteIngredient(id) {
        const isUsed = savedRecipes.some(recipe => recipe.ingredients.some(item => item.ingredientId == id));
        if (isUsed) {
            alert("Este ingrediente não pode ser apagado pois está sendo usado em uma ou mais receitas salvas.");
            return;
        }
        if (confirm("Tem certeza que deseja apagar este ingrediente?")) {
            ingredients = ingredients.filter(ing => ing.id != id);
            saveIngredients();
            rebuildIngredientsTable();
        }
    }

    function rebuildIngredientsTable() {
        const tableBody = document.querySelector('#ingredients-table tbody');
        tableBody.innerHTML = '';
        ingredients.forEach(ing => {
            const row = tableBody.insertRow();
            row.innerHTML = `
                <td>${ing.name}</td>
                <td>R$ ${ing.price.toFixed(2)} / ${ing.quantity} ${ing.unit}</td>
                <td class="actions-cell">
                    <button class="btn-edit" onclick="editIngredient(${ing.id})">Editar</button>
                    <button class="btn-delete" onclick="deleteIngredient(${ing.id})">Apagar</button>
                </td>
            `;
        });
        updateAllRecipeIngredientDropdowns();
    }

    function clearIngredientForm() {
        document.getElementById('ingredient-id').value = '';
        document.getElementById('ingredient-name').value = '';
        document.getElementById('ingredient-price').value = '';
        document.getElementById('ingredient-quantity').value = '';
        document.getElementById('ingredient-submit-btn').textContent = "Adicionar Ingrediente";
    }

    // Funções de Gerenciamento de Receitas
    function addRecipeIngredientField(ingredientId = '', quantity = '', unit = '') {
        const container = document.getElementById('recipe-ingredients');
        const newField = document.createElement('div');
        newField.className = 'recipe-ingredient-row';
        newField.innerHTML = `
            <select class="ing-select" onchange="updateRecipeIngredientUnit(this)"></select>
            <input type="number" class="ing-qty" placeholder="Qtd." value="${quantity}">
            <select class="ing-unit"></select>
        `;
        container.appendChild(newField);
        const ingSelect = newField.querySelector('.ing-select');
        updateRecipeIngredientDropdowns(ingSelect);
        if(ingredientId) {
            ingSelect.value = ingredientId;
            updateRecipeIngredientUnit(ingSelect);
            newField.querySelector('.ing-unit').value = unit;
        }
    }
    
    function updateRecipeIngredientUnit(selectElement) {
        const unitSelect = selectElement.nextElementSibling.nextElementSibling;
        const selectedId = selectElement.value;
        unitSelect.innerHTML = '';
        if (!selectedId) return;

        const ingredient = ingredients.find(ing => ing.id == selectedId);
        if (!ingredient) return;

        const options = (ingredient.unit === 'kg' || ingredient.unit === 'g') ? ['g', 'kg'] :
                        (ingredient.unit === 'l' || ingredient.unit === 'ml') ? ['ml', 'l'] :
                        [ingredient.unit];
        
        options.forEach(option => {
            unitSelect.innerHTML += `<option value="${option}">${option}</option>`;
        });
    }

    function updateAllRecipeIngredientDropdowns() {
        document.querySelectorAll('.ing-select').forEach(updateRecipeIngredientDropdowns);
    }
    
    function updateRecipeIngredientDropdowns(selectElement) {
        const selectedValue = selectElement.value;
        selectElement.innerHTML = '<option value="">Selecione...</option>';
        ingredients.forEach(ing => {
            selectElement.innerHTML += `<option value="${ing.id}">${ing.name}</option>`;
        });
        selectElement.value = selectedValue;
    }

    function getRecipeDataFromForm() {
        let recipeIngredients = [];
        document.querySelectorAll('.recipe-ingredient-row').forEach(row => {
            const ingredientId = row.querySelector('.ing-select').value;
            const quantityUsed = parseFloat(row.querySelector('.ing-qty').value);
            const unitUsed = row.querySelector('.ing-unit').value;
            if (ingredientId && !isNaN(quantityUsed)) {
                recipeIngredients.push({ ingredientId: parseInt(ingredientId), quantityUsed, unitUsed });
            }
        });

        return {
            id: document.getElementById('recipe-id').value ? parseInt(document.getElementById('recipe-id').value) : Date.now(),
            name: document.getElementById('recipe-name').value.trim(),
            ingredients: recipeIngredients,
            profitMargin: parseFloat(document.getElementById('profit-margin').value) || 0,
            additionalTax: parseFloat(document.getElementById('additional-tax').value) || 0,
            perOrderFeePercentage: parseFloat(document.getElementById('per-order-fee-percentage').value) || 0
        };
    }
    
    function calculatePrice(recipeData) {
        let totalCost = 0;
        recipeData.ingredients.forEach(item => {
            const ingredient = ingredients.find(ing => ing.id == item.ingredientId);
            if (!ingredient) return;
            let quantityInBaseUnit = item.quantityUsed;

            if (ingredient.unit === 'kg' && item.unitUsed === 'g') quantityInBaseUnit /= 1000;
            else if (ingredient.unit === 'g' && item.unitUsed === 'kg') quantityInBaseUnit *= 1000;
            else if (ingredient.unit === 'l' && item.unitUsed === 'ml') quantityInBaseUnit /= 1000;
            else if (ingredient.unit === 'ml' && item.unitUsed === 'l') quantityInBaseUnit *= 1000;
            
            totalCost += (ingredient.price / ingredient.quantity) * quantityInBaseUnit;
        });

        const costWithTaxes = totalCost * (1 + (recipeData.additionalTax / 100));
        const basePrice = costWithTaxes * (1 + (recipeData.profitMargin / 100));
        let finalPrice = basePrice;
        if (recipeData.perOrderFeePercentage > 0 && recipeData.perOrderFeePercentage < 100) {
            finalPrice = basePrice / (1 - (recipeData.perOrderFeePercentage / 100));
        }
        return { totalCost, finalPrice };
    }

    function calculateAndDisplayCurrentRecipe() {
        const recipeData = getRecipeDataFromForm();
        if (recipeData.ingredients.length === 0) {
            document.getElementById('recipe-cost-result').innerHTML = '';
            alert("Adicione pelo menos um ingrediente para calcular.");
            return;
        }
        const { totalCost, finalPrice } = calculatePrice(recipeData);
        document.getElementById('recipe-cost-result').innerHTML = `
            <p><strong>Custo Total da Receita:</strong> R$ ${totalCost.toFixed(2)}</p>
            <p><strong>Preço de Venda Sugerido:</strong> R$ ${finalPrice.toFixed(2)}</p>
        `;
    }

    function saveOrUpdateRecipe() {
        const recipeData = getRecipeDataFromForm();
        if (!recipeData.name || recipeData.ingredients.length === 0) {
            alert("Preencha o nome da receita e adicione ao menos um ingrediente.");
            return;
        }

        const existingIndex = savedRecipes.findIndex(r => r.id == recipeData.id);
        if (existingIndex > -1) { // Atualizando
            savedRecipes[existingIndex] = recipeData;
        } else { // Salvando
            savedRecipes.push(recipeData);
        }
        
        saveRecipes();
        rebuildSavedRecipes();
        clearRecipeForm();
        document.getElementById('tab-btn-receitas-salvas').click();
    }
    
    function editSavedRecipe(id) {
        const recipe = savedRecipes.find(r => r.id == id);
        if (!recipe) return;
        clearRecipeForm(false);
        
        document.getElementById('recipe-form-title').textContent = "Editando Receita";
        document.getElementById('recipe-id').value = recipe.id;
        document.getElementById('recipe-name').value = recipe.name;
        document.getElementById('profit-margin').value = recipe.profitMargin;
        document.getElementById('additional-tax').value = recipe.additionalTax;
        document.getElementById('per-order-fee-percentage').value = recipe.perOrderFeePercentage;

        recipe.ingredients.forEach(item => {
            addRecipeIngredientField(item.ingredientId, item.quantityUsed, item.unitUsed);
        });
        
        document.getElementById('recipe-submit-btn').textContent = "Atualizar Receita";
        document.getElementById('tab-btn-receitas').click();
    }

    function deleteSavedRecipe(id) {
        if (confirm("Tem certeza que deseja apagar esta receita?")) {
            savedRecipes = savedRecipes.filter(r => r.id != id);
            saveRecipes();
            rebuildSavedRecipes();
        }
    }
    
    function duplicateSavedRecipe(id) {
        const originalRecipe = savedRecipes.find(r => r.id == id);
        if (!originalRecipe) return;
        const newRecipe = JSON.parse(JSON.stringify(originalRecipe)); // Deep copy
        newRecipe.id = Date.now();
        newRecipe.name = `${originalRecipe.name} (cópia)`;
        savedRecipes.push(newRecipe);
        saveRecipes();
        rebuildSavedRecipes();
    }

    function rebuildSavedRecipes() {
        const container = document.getElementById('saved-recipes-container');
        container.innerHTML = '';
        if (savedRecipes.length === 0) {
            container.innerHTML = '<p>Nenhuma receita salva ainda.</p>';
        }

        savedRecipes.forEach(recipe => {
            const { totalCost, finalPrice } = calculatePrice(recipe);
            let detailsHtml = '<ul>';
            recipe.ingredients.forEach(item => {
                const ingredient = ingredients.find(ing => ing.id == item.ingredientId);
                if (ingredient) detailsHtml += `<li>${ingredient.name}: ${item.quantityUsed} ${item.unitUsed}</li>`;
            });
            detailsHtml += '</ul>';
            detailsHtml += `<p><strong>Lucro:</strong> ${recipe.profitMargin}% | <strong>Custos Adic.:</strong> ${recipe.additionalTax}% | <strong>Taxa Pedido:</strong> ${recipe.perOrderFeePercentage}%</p>`;

            const card = document.createElement('div');
            card.className = 'saved-recipe-card';
            card.innerHTML = `
                <div class="saved-recipe-card-header">
                    <div class="saved-recipe-card-header-title" onclick="toggleRecipeDetails(this.closest('.saved-recipe-card'))">
                        <h4>${recipe.name}</h4>
                        <small>Custo: R$ ${totalCost.toFixed(2)} | Venda: R$ ${finalPrice.toFixed(2)}</small>
                    </div>
                    <div class="menu-container">
                        <button class="menu-button" onclick="toggleActionMenu(this)">&#8942;</button>
                        <div class="menu-dropdown">
                            <a href="#" onclick="editSavedRecipe(${recipe.id})">Editar</a>
                            <a href="#" onclick="duplicateSavedRecipe(${recipe.id})">Duplicar</a>
                            <a href="#" onclick="deleteSavedRecipe(${recipe.id})">Apagar</a>
                        </div>
                    </div>
                </div>
                <div class="recipe-details">${detailsHtml}</div>
            `;
            container.appendChild(card);
        });
    }

    function updateAllSavedRecipes() {
        rebuildSavedRecipes();
    }

    function clearRecipeForm(addFirstField = true) {
        document.getElementById('recipe-form-title').textContent = "Nova Receita";
        document.getElementById('recipe-id').value = '';
        document.getElementById('recipe-name').value = '';
        document.getElementById('recipe-ingredients').innerHTML = '';
        if(addFirstField) addRecipeIngredientField();
        document.getElementById('profit-margin').value = '';
        document.getElementById('additional-tax').value = '';
        document.getElementById('per-order-fee-percentage').value = '';
        document.getElementById('recipe-cost-result').innerHTML = '';
        document.getElementById('recipe-submit-btn').textContent = "Salvar Receita";
    }

    // Funções de Persistência com localStorage
    function saveIngredients() {
        localStorage.setItem('confeitaria_ingredients', JSON.stringify(ingredients));
    }

    function loadIngredients() {
        const storedIngredients = localStorage.getItem('confeitaria_ingredients');
        if (storedIngredients) {
            ingredients = JSON.parse(storedIngredients);
        }
    }

    function saveRecipes() {
        localStorage.setItem('confeitaria_savedRecipes', JSON.stringify(savedRecipes));
    }

    function loadRecipes() {
        const storedRecipes = localStorage.getItem('confeitaria_savedRecipes');
        if (storedRecipes) {
            savedRecipes = JSON.parse(storedRecipes);
        }
    }

    // Funções de Backup
    function exportBackup() {
        const backupData = {
            ingredients: ingredients,
            savedRecipes: savedRecipes
        };
        const dataStr = JSON.stringify(backupData, null, 2);
        const blob = new Blob([dataStr], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `precificacao_confeitaria_backup_${new Date().toISOString().slice(0, 10)}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    function importBackup(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const importedData = JSON.parse(e.target.result);
                if (importedData.ingredients && importedData.savedRecipes) {
                    if (confirm("Importar o backup irá APAGAR os dados atuais. Deseja continuar?")) {
                        ingredients = importedData.ingredients;
                        savedRecipes = importedData.savedRecipes;
                        saveIngredients();
                        saveRecipes();
                        rebuildIngredientsTable();
                        rebuildSavedRecipes();
                        alert("Backup importado com sucesso!");
                    }
                } else {
                    alert("Formato do arquivo de backup inválido.");
                }
            } catch (error) {
                alert("Erro ao ler o arquivo. Por favor, verifique se é um arquivo de backup válido.");
            }
        };
        reader.readAsText(file);
    }

    // Inicia a aplicação
    document.addEventListener('DOMContentLoaded', () => {
        loadIngredients();
        loadRecipes();
        rebuildIngredientsTable();
        rebuildSavedRecipes();
        clearRecipeForm();
    });
</script>

</body>
</html>
